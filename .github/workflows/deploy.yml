name: Deploy to Server

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build
        run: go build -o doppelcord

      - name: Create .env
        run: |
          cat > /opt/doppelcord/.env << EOF
          DISCORD_BOT_TOKEN=${{ secrets.DISCORD_BOT_TOKEN }}
          GUILD_ID=${{ secrets.GUILD_ID }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_SSLMODE=${{ secrets.DB_SSLMODE }}
          LLM_API_URL=${{ secrets.LLM_API_URL }}
          LLM_API_KEY=${{ secrets.LLM_API_KEY }}
          LLM_MODEL=${{ secrets.LLM_MODEL }}
          EOF

      - name: Deploy
        run: |
          sudo systemctl stop doppelcord || true
          cp doppelcord /opt/doppelcord/
          sudo cp deploy/doppelcord.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl start doppelcord
